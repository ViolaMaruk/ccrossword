<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interaktywny krzyżówka matematyczny (polski)</title>
  <style>
    :root {
      --cell-size: 44px;
      --accent: #2563eb;
      --bg: #071029;
      --panel: #0b1220;
      --text: #e6eef8;
      --muted: #9aa6bf;
      --ok: #10b981;
      --bad: #ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", sans-serif;
      background: linear-gradient(180deg,#061025 0%, #071426 100%); color:var(--text);
      min-height:100vh; display:flex; flex-direction:column;
    }
    .toolbar{
      display:flex; gap:.6rem; align-items:center; padding:.8rem; background:rgba(8,12,22,.6);
      border-bottom:1px solid rgba(255,255,255,.03); position:sticky; top:0; z-index:10; flex-wrap:wrap;
    }
    .toolbar label{font-size:.85rem; color:var(--muted); margin-left:.2rem}
    input[type="text"], input[type="number"]{ background:#071426; border:1px solid #223043; color:var(--text); padding:.45rem .6rem; border-radius:.6rem; outline:none; }
    .btn{ background:#0f1724; border:1px solid #263242; color:var(--text); padding:.5rem .7rem; border-radius:.6rem; cursor:pointer;}
    .btn.primary{ background:var(--accent); border-color:#1e40af; }
    .btn.warn{ background:var(--bad); border-color:#b91c1c; color:#fff;}
    .badge{ padding:.35rem .6rem; border-radius:.5rem; background:#0c1830; border:1px solid #233047; color:#bcdfff; font-weight:600}
    .wrap{ display:flex; justify-content:center; padding:1rem; gap:1rem; flex:1; }
    .board{
      position:relative; width:min(960px, 96%); aspect-ratio: 4/5; background:#061021; border-radius:12px; overflow:hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.03);
    }
    .bg{ position:absolute; inset:0; background-size:contain; background-position:center; background-repeat:no-repeat; z-index:0; filter:contrast(1.02) saturate(1.05);}
    .cell{ position:absolute; z-index:2; }
    .cell input{
      width:var(--cell-size); height:var(--cell-size); text-align:center; font-weight:700;
      font-size:calc(var(--cell-size) * .5); border-radius:.5rem;
      border:2px solid #9fb5ff; background:#f1f8ff; color:#022034; outline:none;
    }
    .cell.editable::after{
      content:"✥"; position:absolute; right:-10px; top:-10px; width:24px; height:24px; display:grid; place-items:center;
      background:#06b6d4; color:#022034; border-radius:999px; font-size:12px; border:2px solid #064e63; box-shadow:0 6px 16px rgba(0,0,0,.35);
      cursor:grab;
    }
    .hint{ text-align:center; color:var(--muted); margin-top:.6rem }
    .controls-sep{ width:1px; height:34px; background:rgba(255,255,255,.03); margin:0 .4rem;}
    .small{ font-size:.86rem; color:var(--muted); }
    .status{ margin-left:auto; font-size:.86rem; color:var(--muted) }
    .hidden{ display:none !important; }
    @media (max-width:720px){ .toolbar{ gap:.4rem } .badge{ font-size:.85rem } }
  </style>
</head>
<body>
  <div class="toolbar">
    <span class="badge" id="modeBadge">Tryb: uczeń</span>
    <button class="btn" id="toggleEdit">Włącz edycję</button>

    <label class="small" for="imgUrl">Tło:</label>
    <input id="imgUrl" type="text" placeholder="Wklej link do obrazka (PNG/JPG)" />

    <button class="btn" id="applyBg">Zastosuj</button>

    <div class="controls-sep"></div>

    <label class="small" for="cellSize">Rozmiar pola:</label>
    <input id="cellSize" type="number" min="24" max="100" value="44" style="width:78px"/>

    <button class="btn" id="addCell">Dodaj pole</button>
    <button class="btn" id="clearCells" title="Usuń wszystkie pola">Wyczyść</button>

    <div class="controls-sep"></div>

    <button class="btn primary" id="share">Link dla uczniów</button>
    <button class="btn" id="copyAnswers">Kopiuj odpowiedzi (JSON)</button>
    <button class="btn" id="check">Sprawdź</button>
    <button class="btn" id="reveal">Pokaż odpowiedzi</button>

    <span class="status" id="statusInfo"></span>
  </div>

  <div class="wrap">
    <div class="board" id="board">
      <div class="bg" id="bg"></div>
      <!-- pola będą dodawane скриптом -->
    </div>
  </div>
  <div class="hint">Uwaga: w trybie edycji pola są zablokowane do wpisywania — wyłącz edycję, aby wpisywać liczby. Kliknij "Link dla uczniów", aby skopiować URL z układem.</div>

<script>
  // ====== Stan aplikacji ======
  const state = {
    edit: false,
    bg: '',
    size: 44,
    cells: [] // { id, x, y, value, answer (opcjonalnie) }
  };

  const board = document.getElementById('board');
  const bgEl = document.getElementById('bg');
  const imgUrl = document.getElementById('imgUrl');
  const cellSizeInput = document.getElementById('cellSize');
  const modeBadge = document.getElementById('modeBadge');
  const statusInfo = document.getElementById('statusInfo');

  // ====== Pomocnicze ======
  const uid = ()=>Math.random().toString(36).slice(2,9);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function render(){
    document.documentElement.style.setProperty('--cell-size', state.size+'px');
    bgEl.style.backgroundImage = state.bg ? `url("${state.bg}")` : 'none';
    // usuń stare pola
    [...board.querySelectorAll('.cell')].forEach(n=>n.remove());
    // wyrenderuj
    for(const c of state.cells){
      const el = document.createElement('div');
      el.className = 'cell' + (state.edit ? ' editable' : '');
      el.style.left = (c.x * board.clientWidth) + 'px';
      el.style.top = (c.y * board.clientHeight) + 'px';
      el.dataset.id = c.id;

      const input = document.createElement('input');
      input.value = c.value || '';
      input.placeholder = '';
      input.disabled = state.edit; // w edycji pola blokowane
      input.addEventListener('input', ()=>{ c.value = input.value; autosave(); });
      el.appendChild(input);
      board.appendChild(el);

      if(state.edit) enableDrag(el, c);
      if(state.edit) el.addEventListener('contextmenu', e=>{ e.preventDefault(); removeCell(c.id); });

      // jeśli jest pole odpowiedzi - ustaw atrybuty pomocnicze
      if(!state.edit && c._lastCheck){
        // po sprawdzeniu kolorujemy - logika sprawdzania wykonana przy kliknięciu "Sprawdź"
      }
    }
    modeBadge.textContent = 'Tryb: ' + (state.edit ? 'edytor' : 'uczeń');
    statusInfo.textContent = '';
  }

  function addCell(xPct=0.5,yPct=0.5, answer=''){
    state.cells.push({ id: uid(), x: xPct, y: yPct, value:'', answer: answer });
    render(); autosave();
  }
  function removeCell(id){
    state.cells = state.cells.filter(c=>c.id !== id);
    render(); autosave();
  }

  function enableDrag(el,c){
    let dragging=false, sx=0, sy=0, startLeft=0, startTop=0;
    el.addEventListener('mousedown', (e)=>{
      if(!state.edit) return;
      dragging=true; el.style.cursor='grabbing'; sx=e.clientX; sy=e.clientY;
      startLeft = parseFloat(el.style.left); startTop = parseFloat(el.style.top);
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      let nx = startLeft + dx, ny = startTop + dy;
      const inputSize = parseFloat(getComputedStyle(el.firstChild).width);
      nx = clamp(nx, 0, board.clientWidth - inputSize);
      ny = clamp(ny, 0, board.clientHeight - inputSize);
      el.style.left = nx + 'px'; el.style.top = ny + 'px';
      c.x = nx / board.clientWidth; c.y = ny / board.clientHeight;
    });
    window.addEventListener('mouseup', ()=>{
      if(dragging){ dragging=false; el.style.cursor='grab'; autosave(); }
    });
  }

  // ====== Hash encode/decode (układ + poprawne odpowiedzi) ======
  function encodeLayout(){
    const payload = { bg: state.bg, size: state.size, cells: state.cells.map(c=>({ x:c.x, y:c.y, answer:c.answer||'' })) };
    return btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  }
  function decodeLayout(str){
    try{ return JSON.parse(decodeURIComponent(escape(atob(str)))); }catch{ return null }
  }
  function applyLayout(layout){
    if(!layout) return;
    state.bg = layout.bg || '';
    state.size = layout.size || 44;
    state.cells = (layout.cells || []).map(c=>({ id: uid(), x:c.x, y:c.y, value:'', answer:c.answer||'' }));
    imgUrl.value = state.bg || '';
    cellSizeInput.value = state.size;
    render();
  }

  // ====== Autosave tylko układu do localStorage (ułatwia edycję) ======
  const LS_LAYOUT = 'krzyzowka-layout-v1';
  const LS_VALUES = 'krzyzowka-values-v1';
  function autosave(){
    // zapisz wartości w localStorage (dla ucznia)
    try{ const vals = state.cells.map(c=>c.value||''); localStorage.setItem(LS_VALUES, JSON.stringify(vals)); }catch{}
    // zapisz także układ przy edytowaniu
    try{ const layout = { bg: state.bg, size: state.size, cells: state.cells.map(c=>({ x:c.x, y:c.y, answer:c.answer||'' })) }; localStorage.setItem(LS_LAYOUT, JSON.stringify(layout)); }catch{}
  }
  function loadSavedValues(){
    try{
      const raw = localStorage.getItem(LS_VALUES); if(!raw) return;
      const vals = JSON.parse(raw);
      state.cells.forEach((c,i)=>{ if(vals[i]!=null) c.value = vals[i]; });
    }catch{}
  }
  function loadSavedLayout(){
    try{
      const raw = localStorage.getItem(LS_LAYOUT); if(!raw) return false;
      const layout = JSON.parse(raw);
      applyLayout(layout);
      return true;
    }catch{ return false }
  }

  // ====== UI handlers ======
  document.getElementById('toggleEdit').addEventListener('click', ()=>{
    state.edit = !state.edit; render();
    document.getElementById('toggleEdit').textContent = state.edit ? 'Wyłącz edycję' : 'Włącz edycję';
  });

  document.getElementById('applyBg').addEventListener('click', ()=>{
    state.bg = imgUrl.value.trim(); render(); autosave();
  });

  cellSizeInput.addEventListener('change', ()=>{
    const v = parseInt(cellSizeInput.value,10) || 44;
    state.size = clamp(v, 24, 100); render(); autosave();
  });

  document.getElementById('addCell').addEventListener('click', ()=>{
    if(!state.edit){ alert('Najpierw włącz tryb edycji'); return; }
    addCell(0.5,0.5,''); // puste pole (odpowiedź można wpisać ręcznie w kodzie lub w layoucie)
  });

  document.getElementById('clearCells').addEventListener('click', ()=>{
    if(!state.edit){ alert('Dostępne w trybie edycji'); return; }
    if(confirm('Usunąć wszystkie pola?')){ state.cells=[]; render(); autosave(); }
  });

  document.getElementById('share').addEventListener('click', ()=>{
    const token = encodeLayout();
    const url = location.origin + location.pathname + '#layout=' + token;
    navigator.clipboard?.writeText(url);
    alert('Link skopiowany do schowka. Wyślij go uczniom.');
  });

  // Kopiowanie odpowiedzi ucznia (JSON)
  document.getElementById('copyAnswers').addEventListener('click', ()=>{
    const payload = state.cells.map(c=>({ id: c.id, x: c.x, y: c.y, value: c.value || '' }));
    const text = JSON.stringify({ timestamp: new Date().toISOString(), answers: payload }, null, 2);
    navigator.clipboard?.writeText(text).then(()=>{ statusInfo.textContent = 'Odpowiedzi skopiowane do schowka'; setTimeout(()=>statusInfo.textContent='',2500); });
  });

  // Sprawdzanie odpowiedzi: podświetla zielono/czerwono
  document.getElementById('check').addEventListener('click', ()=>{
    // weź poprawne odpowiedzi z state.cells[].answer
    let total = 0, correct = 0;
    for(const c of state.cells){
      total++;
      const el = board.querySelector(`[data-id="${c.id}"] input`);
      const val = (c.value||'').toString().trim();
      const ans = (c.answer||'').toString().trim();
      el.style.transition='background .15s ease, border-color .15s ease';
      if(ans === ''){ // brak klucza
        el.style.boxShadow = '0 0 0 3px rgba(255,255,255,0.03)';
        el.style.borderColor = '#9fb5ff';
      } else if(val === ans){
        el.style.background = 'hsl(150 60% 86%)'; el.style.borderColor = 'hsl(150 60% 45%)'; correct++;
      } else {
        el.style.background = 'hsl(0 78% 92%)'; el.style.borderColor = 'hsl(0 78% 42%)';
      }
    }
    statusInfo.textContent = `Sprawdzono: ${correct}/${total} poprawnych`;
    setTimeout(()=>statusInfo.textContent='', 5000);
  });

  // Reveal answers (toggle)
  let revealed = false;
  document.getElementById('reveal').addEventListener('click', ()=>{
    revealed = !revealed;
    for(const c of state.cells){
      const el = board.querySelector(`[data-id="${c.id}"] input`);
      if(revealed){
        el.dataset._old = el.value || '';
        el.value = c.answer || '';
      } else {
        el.value = el.dataset._old || '';
      }
    }
    statusInfo.textContent = revealed ? 'Odpowiedzi widoczne' : 'Odpowiedzi ukryte';
    setTimeout(()=>statusInfo.textContent='',2000);
  });

  // Dodawanie pola po kliknięciu na planszę (tylko w edycji)
  board.addEventListener('click', (e)=>{
    if(!state.edit) return;
    if(e.target !== board && !e.target.classList.contains('bg')) return;
    const rect = board.getBoundingClientRect();
    const xPct = (e.clientX - rect.left - state.size/2) / board.clientWidth;
    const yPct = (e.clientY - rect.top - state.size/2) / board.clientHeight;
    addCell(clamp(xPct,0,1), clamp(yPct,0,1), '');
  });

  // adaptacja przy resize
  window.addEventListener('resize', ()=>render());

  // ====== Inicjalizacja: spróbuj załadować layout z hash lub z localStorage ======
  function initFromHash(){
    const m = location.hash.match(/^#layout=(.+)$/);
    if(m){
      const layout = decodeLayout(m[1]);
      applyLayout(layout);
      loadSavedValues();
      return true;
    }
    return false;
  }

  // jeśli brak layoutu w URL - spróbuj localStorage
  const found = initFromHash();
  if(!found){
    const got = loadSavedLayout();
    if(!got){
      // --- przykładowy, mały układ demo (3 pola) ---
      // możesz go edytować: albo w edycji dodaj pola, albo usuń i wgraj własne tło
      state.bg = ''; // pusty — wklej link do obrazka
      state.size = 44;
      state.cells = [
        // przykładowe pola z poprawnymi odpowiedziami (tutaj puste)
        // { id: uid(), x:0.2, y:0.22, value:'', answer:'12' },
        // { id: uid(), x:0.55, y:0.22, value:'', answer:'7' },
        // { id: uid(), x:0.35, y:0.6, value:'', answer:'9' }
      ];
      render();
    } else {
      loadSavedValues();
    }
  } else {
    // jeśli layout z hash - załaduj wartości z storage (np. jeśli otwierasz jako uczeń)
    loadSavedValues();
  }

  // ====== Dodatkowa pomoc: wczytaj układ JSON z pola prompt (jeśli chcesz wstawić gotowy layout) ======
  // (opcjonalne) - nie używać automatycznie
  function importLayoutFromJSON(json){
    try{
      const obj = typeof json === 'string' ? JSON.parse(json) : json;
      if(obj.cells){
        state.bg = obj.bg || '';
        state.size = obj.size || state.size;
        state.cells = (obj.cells||[]).map(c=>({ id: uid(), x: c.x, y: c.y, value:'', answer: c.answer || '' }));
        imgUrl.value = state.bg;
        cellSizeInput.value = state.size;
        render(); autosave();
      }
    }catch(e){ console.error('Invalid layout JSON', e); }
  }

  // expose utility to window for teacher convenience
  window.importLayoutFromJSON = importLayoutFromJSON;

</script>
</body>
</html>
